<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Cometa - Lace Bulk DRep Delegation</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; color: #1a1a1a; margin: 0; padding: 2em; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { color: #1a1a1a; border-bottom: 1px solid #eee; padding-bottom: 0.5em; }
        button { background-color: #1a8ed1; color: white; border: none; padding: 12px 18px; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px; transition: background-color 0.2s; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #136da2; }
        #disconnect-btn { background-color: #6c757d; }
        #disconnect-btn:hover:not(:disabled) { background-color: #5a6268; }
        input[type="text"], select { font-size: 16px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 100%; margin-bottom: 1em; box-sizing: border-box; }
        select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        #log-output { background-color: #2b2b2b; color: #f0f0f0; border-radius: 5px; padding: 15px; margin-top: 20px; font-family: 'SF Mono', 'Courier New', monospace; white-space: pre-wrap; word-wrap: break-word; height: 300px; overflow-y: scroll; }
        #keys-display { margin-top: 1em; font-size: 14px; word-break: break-all; }
        .hidden { display: none; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
<div class="container">
    <h1>Bulk DRep Delegation Tool</h1>

    <div id="connect-section">
        <h2>1. Configure and Connect</h2>
        <select id="network-select">
            <option value="preprod">Preprod Testnet</option>
            <option value="preview">Preview Testnet</option>
            <option value="mainnet">Mainnet</option>
        </select>
        <input type="text" id="blockfrost-key-input" placeholder="Enter Blockfrost Project ID for selected network" />
        <button id="connect-btn">Connect Lace Wallet</button>
        <button id="disconnect-btn" class="hidden">Disconnect</button>
    </div>

    <div id="delegate-section" class="hidden">
        <h2>2. Registered Stake Keys Found</h2>
        <div id="keys-display"></div>

        <h2>3. Delegate to DRep</h2>
        <input type="text" id="drep-id-input" placeholder="Enter DRep ID (e.g., drep1...)" />
        <button id="delegate-btn" disabled>Delegate All Keys</button>
    </div>

    <pre id="log-output">Awaiting connection...</pre>
</div>

<script src="https://unpkg.com/@biglup/cometa@1.1.101/dist/iife/index.global.js"></script>
<script>
    // --- Configuration ---
    const WALLET_NAME = 'lace';

    // --- UI Elements ---
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const networkSelect = document.getElementById('network-select');
    const delegateSection = document.getElementById('delegate-section');
    const keysDisplay = document.getElementById('keys-display');
    const blockfrostKeyInput = document.getElementById('blockfrost-key-input');
    const drepIdInput = document.getElementById('drep-id-input');
    const delegateBtn = document.getElementById('delegate-btn');
    const logOutput = document.getElementById('log-output');

    // --- App State ---
    let wallet = null;
    let provider = null;
    let registeredStakeKeys = [];

    // --- Helper Functions ---
    const log = (message, type = 'info') => {
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        if (type === 'success') line.className = 'success';
        if (type === 'error') line.className = 'error';
        logOutput.appendChild(line);
        logOutput.scrollTop = logOutput.scrollHeight;
    };

    const waitForCardanoWallet = (timeout = 3000) => {
        return new Promise((resolve, reject) => {
            const check = () => {
                if (window.cardano && window.cardano[WALLET_NAME]) {
                    clearInterval(interval);
                    resolve(window.cardano[WALLET_NAME]);
                }
            };
            const interval = setInterval(check, 100);
            setTimeout(() => {
                clearInterval(interval);
                reject(new Error(`Wallet extension '${WALLET_NAME}' not found after 3 seconds.`));
            }, timeout);
            check();
        });
    };

    // --- Main Logic ---
    const disconnect = () => {
        // CIP-30 has no disconnect method, so we reset the app's state
        wallet = null;
        provider = null;
        registeredStakeKeys = [];

        // Reset UI
        delegateSection.classList.add('hidden');
        disconnectBtn.classList.add('hidden');
        keysDisplay.innerHTML = '';
        drepIdInput.value = '';

        connectBtn.disabled = false;
        blockfrostKeyInput.disabled = false;
        networkSelect.disabled = false;
        delegateBtn.disabled = true;

        log('Wallet disconnected. Please reconnect to continue.');
    };

    document.addEventListener('DOMContentLoaded', async () => {
        await Cometa.ready();
        log('Cometa.js is ready. Please select a network, provide your key, and connect your wallet.');

        connectBtn.addEventListener('click', async () => {
            const selectedNetwork = networkSelect.value;
            const blockfrostKey = blockfrostKeyInput.value.trim();
            if (!blockfrostKey) {
                log('Please enter a Blockfrost Project ID before connecting.', 'error');
                return;
            }

            const networkMap = {
                mainnet: Cometa.NetworkMagic.Mainnet,
                preprod: Cometa.NetworkMagic.Preprod,
                preview: Cometa.NetworkMagic.Preview,
            };

            try {
                log('Waiting for wallet extension...');
                const walletApi = await waitForCardanoWallet();

                log(`Connecting to ${WALLET_NAME} and requesting CIP-95 access...`);
                const cip30Api = await walletApi.enable({ extensions: [{ cip: 95 }] });

                provider = new Cometa.BlockfrostProvider({
                    network: networkMap[selectedNetwork],
                    projectId: blockfrostKey,
                });

                wallet = new Cometa.BrowserExtensionWallet(cip30Api, provider);

                const walletNetworkId = await wallet.getNetworkId();
                const isMainnet = walletNetworkId === 1;

                if ((isMainnet && selectedNetwork !== 'mainnet') || (!isMainnet && selectedNetwork === 'mainnet')) {
                    log(`Wallet is connected to a ${isMainnet ? 'Mainnet' : 'Testnet'} network, but you selected ${selectedNetwork}. Please align your wallet and dropdown selection.`, 'error');
                    disconnect();
                    return;
                }

                log('Wallet connected. Fetching registered stake keys...');
                registeredStakeKeys = await wallet.getRegisteredPubStakeKeys();

                if (registeredStakeKeys.length === 0) {
                    log('No registered stake keys found in this wallet.', 'error');
                    keysDisplay.textContent = 'No registered stake keys found.';
                } else {
                    log(`Found ${registeredStakeKeys.length} registered stake key(s):`, 'success');
                    keysDisplay.innerHTML = registeredStakeKeys.map(key => `<p><code>${key}</code></p>`).join('');
                }

                delegateSection.classList.remove('hidden');
                disconnectBtn.classList.remove('hidden');
                delegateBtn.disabled = false;
                connectBtn.disabled = true;
                blockfrostKeyInput.disabled = true;
                networkSelect.disabled = true;

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        });

        disconnectBtn.addEventListener('click', disconnect);

        delegateBtn.addEventListener('click', async () => {
            const drepId = drepIdInput.value.trim();
            if (!drepId) {
                log('Please enter a DRep ID.', 'error');
                return;
            }
            if (registeredStakeKeys.length === 0) {
                log('There are no registered stake keys to delegate.', 'error');
                return;
            }

            try {
                delegateBtn.disabled = true;
                log(`Preparing to delegate ${registeredStakeKeys.length} key(s) to DRep: ${drepId}`);

                const builder = await wallet.createTransactionBuilder();
                const networkId = await wallet.getNetworkId();

                for (const stakeKeyHex of registeredStakeKeys) {
                    const pubKeyHash = Cometa.Ed25519PublicKey.fromHex(stakeKeyHex).toHashHex();
                    const stakeCredential = { hash: pubKeyHash, type: Cometa.CredentialType.KeyHash };
                    const rewardAddress = Cometa.RewardAddress.fromCredentials(networkId, stakeCredential);

                    log(`Adding delegation for: ${rewardAddress.toBech32()}`);
                    builder.delegateVotingPower({ rewardAddress, drepId });
                }

                log('Building transaction...');
                const unsignedTx = await builder.build();

                log('Please sign the transaction in your wallet...');
                const witnessSet = await wallet.signTransaction(unsignedTx, false);
                const signedTx = Cometa.applyVkeyWitnessSet(unsignedTx, witnessSet);

                log('Submitting transaction...');
                const txId = await wallet.submitTransaction(signedTx);
                log(`Transaction submitted successfully! TxID: ${txId}`, 'success');
            } catch (error) {
                log(`Transaction failed: ${error.message}`, 'error');
            } finally {
                delegateBtn.disabled = false;
            }
        });
    });
</script>
</body>
</html>